<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>원격 WOL API 서버 개발기</title>
<meta
name="description"
content="정적페이지로 운영하는 개발 블로그입니다."
/>
<link
rel="shortcut icon"
type="image/png"
sizes="144x144"
href="/static/favicon-144x144.png"
/>
<link
rel="icon"
type="image/png"
sizes="16x16"
href="/static/favicon-16x16.png"
/>
<link
rel="icon"
type="image/png"
sizes="32x32"
href="/static/favicon-32x32.png"
/>
<link
rel="icon"
type="image/png"
sizes="192x192"
href="/static/favicon-192x192.png"
/>
<link
rel="apple-touch-icon"
sizes="57x57"
href="/static/apple-touch-icon-57x57.png"
/>
<link
rel="apple-touch-icon"
sizes="72x72"
href="/static/apple-touch-icon-72x72.png"
/>
<link
rel="apple-touch-icon"
sizes="76x76"
href="/static/apple-touch-icon-76x76.png"
/>
<link
rel="apple-touch-icon"
sizes="114x114"
href="/static/apple-touch-icon-114x114.png"
/>
<link
rel="apple-touch-icon"
sizes="120x120"
href="/static/apple-touch-icon-120x120.png"
/>
<link
rel="apple-touch-icon"
sizes="144x144"
href="/static/apple-touch-icon-144x144.png"
/>
<link
rel="apple-touch-icon"
sizes="152x152"
href="/static/apple-touch-icon-152x152.png"
/>
<link
rel="apple-touch-icon"
sizes="154x154"
href="/static/apple-touch-icon-154x154.png"
/>
<link
rel="apple-touch-icon"
sizes="180x180"
href="/static/apple-touch-icon-180x180.png"
/>
<link rel="stylesheet" href="/static/style.css">
<meta name="theme-color" content="#ff5722">
<meta property="og:type" content="website">
<meta property="og:title" content="원격 WOL API 서버 개발기">
<meta property="og:description" content="공부한 개발 정보를 공유합니다.">
<meta property="og:image" content="https://devblog.lazyig.com/122//static/ogimg.png">
<meta property="og:url" content="https://devblog.lazyig.com/122/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8149987977999297" crossorigin="anonymous"></script>
<link rel="stylesheet"
href="/static/highlight.css">
</head>
<body class="kigui one">
<header class="kigui header">
<div class="header-buttons">
<span id="headerBtn" class="nav-header-btn"><img src="/static/menu-w.svg" alt="Menu"></span>
</div>
<a href="/">
<h1 class="title">
메모용 개발 블로그
</h1>
</a>
</header>
<div class="kigui header-space"></div>
<section class="kigui">
<div id="navBar" class="nav-bar">

<div class="nav-header">
<span id="catToggle" class="nav-header-btn"><img src="/static/menu.svg" alt="Menu"></span>
</div>
<ul class="category">

<li style="padding-left: 0px">
<a href="/c/전체보기/1/">전체보기<span class="nav-cat-cnt">(115)</span></a>
</li>

<li style="padding-left: 15px">
<a href="/c/OS/1/">OS<span class="nav-cat-cnt">(35)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/Linux/1/">Linux<span class="nav-cat-cnt">(23)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/MacOS/1/">MacOS<span class="nav-cat-cnt">(8)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Windows/1/">Windows<span class="nav-cat-cnt">(4)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/데이터베이스/1/">데이터베이스<span class="nav-cat-cnt">(3)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/Oracle/1/">Oracle<span class="nav-cat-cnt">(1)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Postgresql/1/">Postgresql<span class="nav-cat-cnt">(1)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/Develop/1/">Develop<span class="nav-cat-cnt">(26)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/CSS3/1/">CSS3<span class="nav-cat-cnt">(3)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Go/1/">Go<span class="nav-cat-cnt">(8)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/HTML5/1/">HTML5<span class="nav-cat-cnt">(2)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Java/1/">Java<span class="nav-cat-cnt">(1)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/JavaScript/1/">JavaScript<span class="nav-cat-cnt">(4)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/React/1/">React<span class="nav-cat-cnt">(2)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Svelte/1/">Svelte<span class="nav-cat-cnt">(2)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/개발일기/1/">개발일기<span class="nav-cat-cnt">(10)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/Docker/1/">Docker<span class="nav-cat-cnt">(1)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/Git/1/">Git<span class="nav-cat-cnt">(3)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/GitLab/1/">GitLab<span class="nav-cat-cnt">(12)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/Nginx/1/">Nginx<span class="nav-cat-cnt">(7)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/기타/1/">기타<span class="nav-cat-cnt">(15)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/이 블로그의 오픈소스/1/">이 블로그의 오픈소스<span class="nav-cat-cnt">(3)</span></a>
</li>



</ul>
</div>
<script>
let catToggle = document.getElementById("catToggle");
let headerBtn = document.getElementById("headerBtn");
let navBar = document.getElementById("navBar");
catToggle.addEventListener("click", () => {
navBar.classList.toggle("show");
});
headerBtn.addEventListener("click", () => {
navBar.classList.toggle("show");
})
</script>
<div class="kigui frame">
<p class="category-path">

<a href="/c/전체보기/1/">전체보기</a>
<span> > </span>

<a href="/c/개발일기/1/">개발일기</a>
<span> > </span>

</p>
<h1 class="article-title"><a href="https://devblog.lazyig.com/122/">원격 WOL API 서버 개발기</a></h1>
<p class="write-date">2024-05-22 14:12:53</p>
<div class="markdown-body">
<h2>WOL?</h2>
<p>Wake On Lan의 약자로 네트워크 카드에서 특정 신호를 수신하면 컴퓨터를 부팅할 수 있게 하는 기능입니다.</p>
<p>여러가지 제약 조건이 있지만 컴퓨터와 다른 공간에 있어도 컴퓨터를 켤 수 있다라는 점은 필요할 경우 매력적인 기능입니다.</p>
<p>그러나  몇 가지 제약 사항이 존재하는데.</p>
<p>메인보드/OS 마다 바이오스 혹은 OS에서 활성화해줘야 하는 구성들이 존재하며, 네트워크 카드(메인보드 내장 네트워크)가 신호를 받아야 하므로 컴퓨터가 부팅은 안되어 있어도 콘센트에 연결되어 최소 전류가 흘러야 합니다.</p>
<p>또한, 네트워크 상으로 WOL 신호를 보내줄 기기가 동일한 망에 존재하여야 합니다. 이는 WOL 신호를 브로드캐스트(컴퓨터가 꺼져있으므로 아이피가 없고 맥 주소만 구분 가능)로 보내야 하기 때문입니다.</p>
<h2>이런걸 왜?</h2>
<p>외부에서 가끔 데스크탑의 성능이나 OS를 활용해야하는 경우가 있습니다.</p>
<p>그러나 항상 켜둘 경우 자원의 낭비가 발생합니다.</p>
<p>필요할땐 켜고 필요없으면 끌 수 있었으면 했습니다.</p>
<p>요즘 나오는 공유기에는 WOL 기능이 존재하여 공유기 페이지를 외부 공개하거나 앱을 사용하면 되지만 제 공유기는 그러한 기능이 없었으며, 다른 서비스에 붙이기를 원했습니다.</p>
<p>그래서 API를 통하여 WOL 신호를 내부 네트워크에 켜져있는 기기에서 보내줄 수 있기를 원하였습니다.</p>
<h2>계획</h2>
<p>서비스 -&gt; API 서버 -&gt; WOL 서버</p>
<p>이러한 순서로 호출하는 구조로 개발하였습니다.</p>
<h3>왜?</h3>
<p>웹 서버에서 수신을 받고 바로 그 프로세스에서 WOL 요청을 보내면 가장 간단하겠지만, 디스코드 봇이나 웹 페이지 등 다양한 곳에서 실행할 수 있기를 원하였습니다.</p>
<p>또한 기존에 도커를 켜고 끄는 기능을 하기 위해서 API 서버를 만들어놓았으므로 여기에 해당 기능이 붙었으면 하였습니다.</p>
<p>그래서 API 서버에 기능을 추가하려하였으나,</p>
<p><strong>그러나...</strong></p>
<p>API 서버는 Docker 환경에서 구동되고 있었으며 네트워크가 외부와 분리되어 있는 환경이였습니다.</p>
<p>WOL 패킷은 브로드캐스트로 Host 기기가 속한 네트워크에서 보내야 합니다.</p>
<p>그럼 그냥 API 서버를 호스트에서 구동하는 간단한 방법이 있지만 포트를 하나 더 쓰기에는 이것저것 켜고 끄고 방화벽에 외부에서 연결하려면 포트포워딩에 관리하기 너무나 귀찮았습니다. 그저 외부에 80번 443번 포트만 열어놓고 쓰고 싶었던 것 이죠.</p>
<p>그리하여 WOL 기능을 하는 서버를 별도로 분리하고 API 서버가 또 API 서버를 호출하는 구조로 변경하였습니다.</p>
<p>이렇게 하면 WOL 서버는 도커 호스트 네트워크 모드로 올려서 간단한 관리를 할 수 있고 WOL 패킷 송신도 가능합니다.</p>
<p>그런데 이렇게 하면 WOL 서버도 API 서버로부터 요청을 받으려면 포트 하나를 점유해야 하는 것 인데. 되도록 포트를 적게 쓰고 싶었기에 네트워크를 통한 통신이 아닌 Unix Domain Socket을 이용하는 것으로 하였습니다.</p>
<h2>개발</h2>
<p>API 서버는 Go + Fiber를 활용하여 이미 구동중인 상태였고, WOL 서버만 간단하게 작성하고 API 서버는 단순히 호출만 해주면 되는 것으로 간단한 개발입니다.</p>
<p>개발 언어 선정은 난이도 대비 적은 자원을 소모할 Go 언어로 선정하였습니다.</p>
<p>마침 Go 1.22에 net/http 패키지 업데이트로 언어 기본 패키지가 편하게 개선되었기에 기본 패키지로 간단하게 개발하는 것으로 정하였습니다.</p>
<p><code>go.mod</code> 파일이 아주 심플하죠?</p>
<pre><code>module wol-server

go 1.22.2

</code></pre>
<p>물론 WOL 패킷을 보내주는 훌륭한 라이브러리가 존재하였지만 의존성이 Go 밖에 없는 심플함을 지키고 싶었기에 WOL 패킷 구조를 확인해봅니다.</p>
<ul>
<li>UDP</li>
<li>9 번 포트</li>
<li>1로 채운 비트 48자리 헤더</li>
<li>맥 주소 (48자리 비트) 16번 반복 바디</li>
</ul>
<p>이렇게만 만족해서 브로드캐스팅(255.255.255.255)을 쏴주면 되므로 그냥.. 그대로 충실하게 작성하였습니다.</p>
<p>0xFF x 6 + 맥주소 x 16</p>
<p><code>wol.go</code></p>
<pre><code class="language-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">&quot;errors&quot;</span>
	<span class="hljs-string">&quot;net&quot;</span>
)

<span class="hljs-comment">// SendWOLPacket WOL 패킷을 전송해주는 메소드</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SendWOLPacket</span><span class="hljs-params">(macAddr <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
	addr, err := net.ResolveUDPAddr(<span class="hljs-string">&quot;udp&quot;</span>, <span class="hljs-string">&quot;255.255.255.255:9&quot;</span>)
	dg := []<span class="hljs-type">byte</span>{}

	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;브로드캐스트 주소 객체 생성 중 오류 발생&quot;</span>)
	}

	conn, err := net.DialUDP(<span class="hljs-string">&quot;udp&quot;</span>, <span class="hljs-literal">nil</span>, addr)

	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;UDP 요청 객체 생성&quot;</span>)
	}

	<span class="hljs-keyword">defer</span> conn.Close()

	hwAddr, err := net.ParseMAC(macAddr)

	<span class="hljs-comment">// MAC 주소 오류</span>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;MAC 주소 파싱 오류: &quot;</span> + macAddr)
	}

	<span class="hljs-comment">// header</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++ {
		dg = <span class="hljs-built_in">append</span>(dg, <span class="hljs-number">0xFF</span>)
	}

	<span class="hljs-comment">// body</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++ {
		dg = <span class="hljs-built_in">append</span>(dg, hwAddr...)
	}

	size, err := conn.Write(dg)

	<span class="hljs-comment">// 잘못된 요청</span>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;요청 오류&quot;</span>)
	}

	<span class="hljs-comment">// 요청 길이 오류(wol 패킷 양식에 맞지 않음)</span>
	<span class="hljs-keyword">if</span> size != <span class="hljs-number">102</span> {
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;요청의 패킷 양식이 맞지 않습니다&quot;</span>)
	}

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

</code></pre>
<p>이어서 API 서버와 통신할 WOL API를 HTTP로 작성하였습니다.</p>
<p><code>main.go</code></p>
<pre><code class="language-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">&quot;log&quot;</span>
	<span class="hljs-string">&quot;net&quot;</span>
	<span class="hljs-string">&quot;net/http&quot;</span>
	<span class="hljs-string">&quot;os&quot;</span>
	<span class="hljs-string">&quot;os/signal&quot;</span>
	<span class="hljs-string">&quot;syscall&quot;</span>
)

<span class="hljs-comment">// SockFilePath unix socket path</span>
<span class="hljs-keyword">var</span> SockFilePath <span class="hljs-type">string</span> = <span class="hljs-string">&quot;/var/run/wol-server/wol-server.sock&quot;</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	socket, err := net.Listen(<span class="hljs-string">&quot;unix&quot;</span>, SockFilePath)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// Cleanup the sockfile.</span>
	c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
	signal.Notify(c, os.Interrupt, syscall.SIGTERM)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		&lt;-c
		os.Remove(SockFilePath)
		os.Exit(<span class="hljs-number">1</span>)
	}()

	mux := http.NewServeMux()

	mux.HandleFunc(<span class="hljs-string">&quot;POST /wol/{macAddr}&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
		log.Println(<span class="hljs-string">&quot;WOL request recived: &quot;</span> + r.PathValue(<span class="hljs-string">&quot;macAddr&quot;</span>))
		SendWOLPacket(r.PathValue(<span class="hljs-string">&quot;macAddr&quot;</span>))
	})

	server := http.Server{
		Handler: mux,
	}

	err = server.Serve(socket)

	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalln(err)
	}
}


</code></pre>
<p>유닉스 도메인 소켓을 통해서 요청 대기를 하도록 작성하였습니다.</p>
<p>이제는 별도의 mux를 추가안해도 <code>POST /wol/{macAddr}</code>처럼 경로명을 인자로 쉽게 받고 메소드까지 제한할 수 있다는 점이 좋습니다.</p>
<p>남은 것은 서버에서 호출입니다.</p>
<p>서버가 유닉스 도메인 소켓으로 대기하고 있으므로 클라이언트(API 서버) 역시 유닉스 도메인 소켓을 통하여야 합니다.</p>
<p><code>wolService.go</code></p>
<pre><code class="language-go"><span class="hljs-keyword">package</span> v1

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">&quot;context&quot;</span>
	<span class="hljs-string">&quot;net&quot;</span>
	<span class="hljs-string">&quot;net/http&quot;</span>

	<span class="hljs-string">&quot;github.com/gofiber/fiber/v2&quot;</span>
)

<span class="hljs-keyword">type</span> WOLResponse <span class="hljs-keyword">struct</span> {
	Ok <span class="hljs-type">bool</span> <span class="hljs-string">`json:&quot;ok&quot;`</span>
}

<span class="hljs-comment">// WOLService godoc</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//	@Summary		Send WOL Packet</span>
<span class="hljs-comment">//	@Description	WOL 패킷으로 컴퓨터를 깨웁니다.</span>
<span class="hljs-comment">//	@Tags			WOL</span>
<span class="hljs-comment">//	@Accept			json</span>
<span class="hljs-comment">//	@Param			Authorization	header		string	false	&quot;인증 키&quot;</span>
<span class="hljs-comment">//	@Success		200				{object}	v1.WOLResponse</span>
<span class="hljs-comment">//	@Param			mac_addr		path		string	true	&quot;맥 주소&quot;</span>
<span class="hljs-comment">//	@Router			/api/v1/wol/{mac_addr} [post]</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WOLService</span><span class="hljs-params">(c *fiber.Ctx)</span></span> <span class="hljs-type">error</span> {
	client := http.Client{
		Transport: &amp;http.Transport{
			DialContext: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_ context.Context, _, _ <span class="hljs-type">string</span>)</span></span> (net.Conn, <span class="hljs-type">error</span>) {
				<span class="hljs-keyword">return</span> net.Dial(<span class="hljs-string">&quot;unix&quot;</span>, <span class="hljs-string">&quot;/var/run/wol-server/wol-server.sock&quot;</span>)
			},
		},
	}

	_, err := client.Post(<span class="hljs-string">&quot;http://unix/wol/&quot;</span>+c.Params(<span class="hljs-string">&quot;mac_addr&quot;</span>), <span class="hljs-string">&quot;application/json&quot;</span>, <span class="hljs-literal">nil</span>)

	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		c.JSON(WOLResponse{
			Ok: <span class="hljs-literal">false</span>,
		})
		<span class="hljs-keyword">return</span> err
	}

	c.JSON(WOLResponse{
		Ok: <span class="hljs-literal">true</span>,
	})

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

</code></pre>
<p>어짜피 혼자만 사용하는 서버이므로 요청할 WOL는 응답같은 것은 작성하지 않았으므로 그냥 내가 잘보냈으면 Ok를 해줍니다.</p>
<p>혼자 쓴다지만 API이므로 Swagger를 이용해서 문서도 작성해주었습니다.</p>
<h2>배포</h2>
<p>배포는 그냥 도커로 통일하였으며, GitLab에 저장소가 위치하므로 GitLab Runner를 통하여 배포도 작성하였습니다.</p>
<p><code>.gitlab-ci.yml</code></p>
<pre><code class="language-yaml"><span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">build</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">release</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">deploy-service</span>

<span class="hljs-string">.if-default-deploy:</span> <span class="hljs-string">&amp;if-default-deploy</span>
  <span class="hljs-attr">if:</span> <span class="hljs-string">($CI_COMMIT_REF_NAME</span> <span class="hljs-string">==</span> <span class="hljs-string">$CI_DEFAULT_BRANCH</span> <span class="hljs-string">||</span> <span class="hljs-string">$CI_COMMIT_REF_NAME</span> <span class="hljs-string">=~</span> <span class="hljs-string">&quot;/gitlab-ci/&quot;</span><span class="hljs-string">)</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">$CI_PIPELINE_SOURCE</span> <span class="hljs-type">!=</span> <span class="hljs-string">&#x27;merge_request_event&#x27;</span>

<span class="hljs-attr">Build:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">build</span>
  <span class="hljs-attr">image:</span> <span class="hljs-string">golang:1.22.2-alpine</span>
  <span class="hljs-attr">rules:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;&lt;:</span> <span class="hljs-string">*if-default-deploy</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">go</span> <span class="hljs-string">build</span>
        <span class="hljs-string">-o</span> <span class="hljs-string">wol-server</span>
        <span class="hljs-string">-ldflags=&quot;-s</span>
                  <span class="hljs-string">-w&quot;</span>
  <span class="hljs-attr">cache:</span>
    <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.go/pkg/mod/</span>
  <span class="hljs-attr">artifacts:</span>
      <span class="hljs-attr">paths:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">./wol-server</span>
      <span class="hljs-attr">expire_in:</span> <span class="hljs-number">1</span> <span class="hljs-string">week</span>
  <span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span>

<span class="hljs-attr">Release docker image:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">release</span>
  <span class="hljs-attr">image:</span> <span class="hljs-string">docker:20.10.16</span>
  <span class="hljs-attr">rules:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;&lt;:</span> <span class="hljs-string">*if-default-deploy</span>
  <span class="hljs-attr">before_script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">-u</span> <span class="hljs-string">&quot;$CI_REGISTRY_USER&quot;</span> <span class="hljs-string">-p</span> <span class="hljs-string">&quot;$CI_REGISTRY_PASSWORD&quot;</span> <span class="hljs-string">$CI_REGISTRY</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:latest</span> <span class="hljs-string">||</span> <span class="hljs-literal">true</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">build</span> <span class="hljs-string">--cache-from</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:latest</span> <span class="hljs-string">--tag</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:latest</span> <span class="hljs-string">.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:latest</span>
  <span class="hljs-attr">resource_group:</span> <span class="hljs-string">registry</span>
  <span class="hljs-attr">dependencies:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">Build</span>
  <span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">docker-host</span>

<span class="hljs-attr">Deploy Server:</span>
    <span class="hljs-attr">stage:</span> <span class="hljs-string">deploy-service</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">docker:20.10.16</span>
    <span class="hljs-attr">rules:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;&lt;:</span> <span class="hljs-string">*if-default-deploy</span>
    <span class="hljs-attr">before_script:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">-u</span> <span class="hljs-string">&quot;$CI_REGISTRY_USER&quot;</span> <span class="hljs-string">-p</span> <span class="hljs-string">&quot;$CI_REGISTRY_PASSWORD&quot;</span> <span class="hljs-string">$CI_REGISTRY</span>
    <span class="hljs-attr">script:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">stop</span> <span class="hljs-string">$CI_PROJECT_NAME</span> <span class="hljs-string">||</span> <span class="hljs-literal">true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">rm</span> <span class="hljs-string">$CI_PROJECT_NAME</span> <span class="hljs-string">||</span> <span class="hljs-literal">true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">|
        docker run \
          --name=$CI_PROJECT_NAME \
          --network=host \
          -v /srv/wol-server/socks:/var/run/wol-server \
          --restart=unless-stopped \
          -d \
          $CI_REGISTRY_IMAGE:latest
</span>    <span class="hljs-attr">resource_group:</span> <span class="hljs-string">deploy</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">docker-host</span>

</code></pre>
<p>GitLab에서 도커 레지스트리도 제공하므로 배포에 관한 모든 것을 GitLab에 의존합니다.</p>
<p>스크립트만 요약해서 보면</p>
<pre><code class="language-sh">go build -o wol-server -ldflags=<span class="hljs-string">&quot;-s -w&quot;</span>
</code></pre>
<p><code>wol-server</code> 파일명으로 빌드를 합니다. 링커 플래그로 각종 불필요한 것을 빼도록 하여 용량을 절약해줍니다.</p>
<pre><code>docker pull $CI_REGISTRY_IMAGE:latest || true
docker build --cache-from $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:latest .
docker push $CI_REGISTRY_IMAGE:latest
</code></pre>
<p>도커 이미지를 빌드하고 올립니다.</p>
<p>이미지 버전따위는 저에게 필요없으므로 latest로 통일합니다.</p>
<p><code>$CI_REGISTRY_IMAGE</code>는 GitLab에서 제공하는 레지스트리 이미지 변수 입니다.</p>
<pre><code>docker stop $CI_PROJECT_NAME || true
docker rm $CI_PROJECT_NAME || true
docker run --name=$CI_PROJECT_NAME \
          --network=host \
          -v /srv/wol-server/socks:/var/run/wol-server \
          --restart=unless-stopped \
          -d \
          $CI_REGISTRY_IMAGE:latest
</code></pre>
<p>기존 배포된 컨테이너를 중지, 삭제하고 새로운 컨테이너를 받아서 실행합니다. 중지, 삭제는 컨테이너가 없을 경우 에러 출력을 낼 수도 있으므로 <code>|| true</code>를 붙여 에러가 없도록 하였습니다.</p>
<p><code>--network=host</code> 호스트 네트워크 모드로 구동</p>
<p><code>-v /srv/wol-server/socks:/var/run/wol-server</code> 유닉스 도메인 소켓 파일을 꺼냅니다. (API 서버에서 사용할 수 있어야 합니다.)</p>
<p><code>--restart=unless-stopped</code> <code>docker stop</code> 하지 않는 이상 무한 재시작</p>
<p><code>-d</code> 백그라운드에서 실행</p>
<p>마찬가지로 API 서버에서도 -v 옵션을 통해 도메인 소켓을 연결해주도록 변경하고 실행합니다.</p>
<h2>실사용</h2>
<p>우선 디스코드 봇에다가 추가하였습니다.</p>
<p><img src="/static/img-z3Z4KYrVwmPzCRuj0msKGx_sRd51o8rKDsv1Ic8qQ6g.png" alt="image-20240522230846421"></p>
<p>그리고 컴퓨터는 몹시 잘 켜졌습니다!</p>
<h2>후기</h2>
<p>개발 노력은 적게 들고 만족도는 좋았습니다.</p>

</div>
</div>
<div class="kigui frame">
<script src="https://utteranc.es/client.js"
repo="lazyig/blog-comment"
issue-term="pathname"
label="blog-comment"
theme="github-light"
crossorigin="anonymous"
async>
</script>
</div>
</section>
</body>
</html>