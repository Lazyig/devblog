<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nginx 도커로 전환기</title>
<meta
name="description"
content="정적페이지로 운영하는 개발 블로그입니다."
/>
<link
rel="shortcut icon"
type="image/png"
sizes="144x144"
href="/static/favicon-144x144.png"
/>
<link
rel="icon"
type="image/png"
sizes="16x16"
href="/static/favicon-16x16.png"
/>
<link
rel="icon"
type="image/png"
sizes="32x32"
href="/static/favicon-32x32.png"
/>
<link
rel="icon"
type="image/png"
sizes="192x192"
href="/static/favicon-192x192.png"
/>
<link
rel="apple-touch-icon"
sizes="57x57"
href="/static/apple-touch-icon-57x57.png"
/>
<link
rel="apple-touch-icon"
sizes="72x72"
href="/static/apple-touch-icon-72x72.png"
/>
<link
rel="apple-touch-icon"
sizes="76x76"
href="/static/apple-touch-icon-76x76.png"
/>
<link
rel="apple-touch-icon"
sizes="114x114"
href="/static/apple-touch-icon-114x114.png"
/>
<link
rel="apple-touch-icon"
sizes="120x120"
href="/static/apple-touch-icon-120x120.png"
/>
<link
rel="apple-touch-icon"
sizes="144x144"
href="/static/apple-touch-icon-144x144.png"
/>
<link
rel="apple-touch-icon"
sizes="152x152"
href="/static/apple-touch-icon-152x152.png"
/>
<link
rel="apple-touch-icon"
sizes="154x154"
href="/static/apple-touch-icon-154x154.png"
/>
<link
rel="apple-touch-icon"
sizes="180x180"
href="/static/apple-touch-icon-180x180.png"
/>
<link rel="stylesheet" href="/static/style.css">
<meta name="theme-color" content="#ff5722">
<meta property="og:type" content="website">
<meta property="og:title" content="Nginx 도커로 전환기">
<meta property="og:description" content="공부한 개발 정보를 공유합니다.">
<meta property="og:image" content="https://devblog.lazyig.com/101//static/ogimg.png">
<meta property="og:url" content="https://devblog.lazyig.com/101/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8149987977999297" crossorigin="anonymous"></script>
<link rel="stylesheet"
href="/static/highlight.css">
</head>
<body class="kigui one">
<header class="kigui header">
<div class="header-buttons">
<span id="headerBtn" class="nav-header-btn"><img src="/static/menu-w.svg" alt="Menu"></span>
</div>
<a href="/">
<h1 class="title">
메모용 개발 블로그
</h1>
</a>
</header>
<div class="kigui header-space"></div>
<section class="kigui">
<div id="navBar" class="nav-bar">

<div class="nav-header">
<span id="catToggle" class="nav-header-btn"><img src="/static/menu.svg" alt="Menu"></span>
</div>
<ul class="category">

<li style="padding-left: 0px">
<a href="/c/전체보기/1/">전체보기<span class="nav-cat-cnt">(100)</span></a>
</li>

<li style="padding-left: 15px">
<a href="/c/OS/1/">OS<span class="nav-cat-cnt">(34)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/Linux/1/">Linux<span class="nav-cat-cnt">(23)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/MacOS/1/">MacOS<span class="nav-cat-cnt">(8)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Windows/1/">Windows<span class="nav-cat-cnt">(3)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/데이터베이스/1/">데이터베이스<span class="nav-cat-cnt">(3)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/Oracle/1/">Oracle<span class="nav-cat-cnt">(1)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Postgresql/1/">Postgresql<span class="nav-cat-cnt">(1)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/Develop/1/">Develop<span class="nav-cat-cnt">(20)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/CSS3/1/">CSS3<span class="nav-cat-cnt">(3)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/HTML5/1/">HTML5<span class="nav-cat-cnt">(2)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/JavaScript/1/">JavaScript<span class="nav-cat-cnt">(4)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/React/1/">React<span class="nav-cat-cnt">(1)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Svelte/1/">Svelte<span class="nav-cat-cnt">(2)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/개발일기/1/">개발일기<span class="nav-cat-cnt">(9)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/Git/1/">Git<span class="nav-cat-cnt">(3)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/GitLab/1/">GitLab<span class="nav-cat-cnt">(11)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/Nginx/1/">Nginx<span class="nav-cat-cnt">(7)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/기타/1/">기타<span class="nav-cat-cnt">(10)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/이 블로그의 오픈소스/1/">이 블로그의 오픈소스<span class="nav-cat-cnt">(3)</span></a>
</li>



</ul>
</div>
<script>
let catToggle = document.getElementById("catToggle");
let headerBtn = document.getElementById("headerBtn");
let navBar = document.getElementById("navBar");
catToggle.addEventListener("click", () => {
navBar.classList.toggle("show");
});
headerBtn.addEventListener("click", () => {
navBar.classList.toggle("show");
})
</script>
<div class="kigui frame">
<p class="category-path">

<a href="/c/전체보기/1/">전체보기</a>
<span> > </span>

<a href="/c/Nginx/1/">Nginx</a>
<span> > </span>

</p>
<h1 class="article-title"><a href="https://devblog.lazyig.com/101/">Nginx 도커로 전환기</a></h1>
<p class="write-date">2023-04-02 16:02:14</p>
<div class="markdown-body">
<h2>서론</h2>
<p>OS에 이런저런 서비스를 올려서 사용하거나 지금의 저 처럼 홈 서버에 이런저런 시도를 많이 하는 경우 환경이 난잡해지고 이를 다른 기기에 그대로 옮길 생각을 하면 그 동안 어질러놓은 업보가 돌아올 것 같아 두렵기까지 합니다.</p>
<p>그래서 이를 점차 정리해나가기 위해서 결국 Docker로 전환하게 되었고 이에 대해서 시도하는 과정을 남기고자 합니다.</p>
<h2>환경</h2>
<p>OS : Linux</p>
<p>배포판 : Ubuntu 18.04.5 LTS</p>
<p>커널 : GNU/Linux 4.15.0-192-generic x86_64</p>
<p>Nginx : nginx/1.19.0 (컴파일 설치)</p>
<h2>본문</h2>
<h3>도커 설치</h3>
<p>해당 시스템에는 과거에 설치한 도커가 있는 상태이며 겸사겸사 구 버전의 도커를 삭제하고 신 버전의 도커를 설치한다.</p>
<p>이러한 과정은 공식 페이지에서 자세하게 소개하고 있으므로 링크의 글을 통하여 진행하면 편하다.</p>
<p><a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p>
<h3>Nginx Docker로 구동</h3>
<h4>이미지 선택</h4>
<p>컴파일 방식이 아닌 기존의 도커 이미지를 사용하도록 변경하기로 하였습니다.</p>
<p>공식 이미지 : <a href="https://hub.docker.com/_/nginx">https://hub.docker.com/_/nginx</a></p>
<p>위 링크에서 공식 이미지를 확인할 수 있습니다.</p>
<p>어짜피 개인서버이므로 현 시점 최신인 <code>nginx:1.23.3</code>을 이용하도록 하겠습니다.</p>
<p>조금이라도 가벼운 이미지를 원하면 <code>alpine</code>이 달린 경량 이미지를 사용하면 됩니다.</p>
<h4>도커 네트워크 생성</h4>
<p>도커 사용 전 같은 기기 내에서 Nginx와 각종 서버들이 켜질때는 각 서버들마다 포트를 다르게 해서 켠 다음 역방향 프록시를 해주어야 했습니다.</p>
<p>하지만 컨테이너로 분리된 환경에서 켤 경우 약간의 IO 손해만 감수하면 컨테이너 마다 아무 포트로 켜고 이를 컨테이너 명으로 접근할 수 있습니다.</p>
<p>포트 관리의 필요성이 사라지게 되고 각 서비스간에 네트워크까지 독립적인 환경을 제공할 수 있습니다.</p>
<pre><code class="language-sh">sudo docker network create 네트워크_명
</code></pre>
<p>위 명령어로 네트워크를 생성합니다.</p>
<h4>컨테이너 실행 설정</h4>
<p>여기서는 관리의 용이함을 위해 <code>docker-compose</code>를 사용하여 컨테이너를 올릴 것 입니다.</p>
<p>이 글에서 작업 공간은 <code>/srv/nginx</code>에서 이루어집니다.</p>
<pre><code class="language-sh">sudo <span class="hljs-built_in">mkdir</span> -p /srv/nginx
<span class="hljs-built_in">cd</span> /srv/nginx
</code></pre>
<p><code>docker-compose</code> 파일을 생성 후 작성합니다.</p>
<pre><code class="language-sh">sudo vim compose.yaml
</code></pre>
<p>(구 버전의 docker의 경우 <code>docker-compose.yaml</code>파일로 생성해주세요.)</p>
<pre><code class="language-yaml"><span class="hljs-attr">services:</span>
    <span class="hljs-attr">nginx:</span>
        <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx</span>
        <span class="hljs-attr">networks:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">네트워크_명</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.23.3</span>
        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
        <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-number">80</span><span class="hljs-string">:80</span>
            <span class="hljs-bullet">-</span> <span class="hljs-number">443</span><span class="hljs-string">:443</span>
        <span class="hljs-attr">volumes:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">./conf:/etc/nginx</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/letsencrypt:/etc/letsencrypt</span>
				<span class="hljs-attr">extra_hosts:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">host.docker.internal:host-gateway</span>
<span class="hljs-attr">networks:</span>
    <span class="hljs-string">네트워크_명:</span>
        <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>설정을 간단하게 설명하자면</p>
<ul>
<li><code>services</code>
<ul>
<li><code>container_name</code>: 컨테이너의 명을 지정합니다. 후에 접근 할 때. 설정한 이름으로 접근할 때 용이합니다.</li>
<li><code>networks</code>: 이 컨테이너가 사용할 네트워크 지정</li>
<li><code>image</code>: 이 컨테이너의 이미지</li>
<li><code>restart</code>: 재 시작 정책. nginx는 항시 켜져야하므로 <code>always</code></li>
<li><code>ports</code>: 컨테이너 외부 호스트와 연결할 포트, HTTPS, HTTP에 해당하는 포트를 바인딩 해주었음.</li>
<li><code>volumes</code>: 호스트 경로와 바인딩할 경로, 유지되어야할 설정파일과 인증서 파일을 연결해주었음.</li>
<li><code>extra_hosts</code>: 아직 다른 서버들이 완전히 도커 컨테이너로 만든 것이 아니므로 호스트로 연결해야할 일이 있을 수 있음. 이 경우 해당 옵션을 추가하고 host.docker.internal로 접근하면 됨.</li>
</ul>
</li>
<li><code>networks</code>: 외부 네트워크를 정의하였음.</li>
</ul>
<p>이후 기존 nginx의 설정들을 복사해옵니다.</p>
<p>저는 기존 설정이 /opt/nginx/conf에 위치해있습니다.</p>
<pre><code class="language-sh">sudo <span class="hljs-built_in">mkdir</span> /srv/nginx/conf
sudo <span class="hljs-built_in">cp</span> -r /opt/nginx/conf/* ./conf
</code></pre>
<p>이후 내부 설정에 각종 경로들을 변경된 경로로 맞춰줘야합니다.</p>
<pre><code class="language-sh">sudo vim /srv/nginx/conf/nginx.conf
</code></pre>
<p>설정파일에 대한 참조 경로나 각종 도메인들을 수정하여야 합니다.</p>
<p>기존 같은 호스트에 켰던 서버들은 <code>localhost</code>를 <code>host.docker.internal</code>로 변경하는 등의 작업이 필요하며 만약 서버들을 도커 컨테이너로 전환하였다면 해당 컨테이너의 바인딩된 포트를 <code>host.docker.internal</code>로 접근할 수도 있지만, 같은 도커 네트워크상에 둔 다음 컨테이너 명을 URL로 연결하면 포트자원에 대한 관리가 수월합니다.</p>
<p>그 다음 컨테이너를 올립니다.</p>
<pre><code class="language-sh">sudo docker compose up -d
</code></pre>
<p>이렇게 구동 부분은 끝났습니다.</p>

</div>
</div>
<div class="kigui frame">
<script src="https://utteranc.es/client.js"
repo="lazyig/blog-comment"
issue-term="pathname"
label="blog-comment"
theme="github-light"
crossorigin="anonymous"
async>
</script>
</div>
</section>
</body>
</html>