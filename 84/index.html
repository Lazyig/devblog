<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>정적 블로그 - GitLab Runner, 도커로 자동 배포</title>
<meta
name="description"
content="정적페이지로 운영하는 개발 블로그입니다."
/>
<link
rel="shortcut icon"
type="image/png"
sizes="144x144"
href="/static/favicon-144x144.png"
/>
<link
rel="icon"
type="image/png"
sizes="16x16"
href="/static/favicon-16x16.png"
/>
<link
rel="icon"
type="image/png"
sizes="32x32"
href="/static/favicon-32x32.png"
/>
<link
rel="icon"
type="image/png"
sizes="192x192"
href="/static/favicon-192x192.png"
/>
<link
rel="apple-touch-icon"
sizes="57x57"
href="/static/apple-touch-icon-57x57.png"
/>
<link
rel="apple-touch-icon"
sizes="72x72"
href="/static/apple-touch-icon-72x72.png"
/>
<link
rel="apple-touch-icon"
sizes="76x76"
href="/static/apple-touch-icon-76x76.png"
/>
<link
rel="apple-touch-icon"
sizes="114x114"
href="/static/apple-touch-icon-114x114.png"
/>
<link
rel="apple-touch-icon"
sizes="120x120"
href="/static/apple-touch-icon-120x120.png"
/>
<link
rel="apple-touch-icon"
sizes="144x144"
href="/static/apple-touch-icon-144x144.png"
/>
<link
rel="apple-touch-icon"
sizes="152x152"
href="/static/apple-touch-icon-152x152.png"
/>
<link
rel="apple-touch-icon"
sizes="154x154"
href="/static/apple-touch-icon-154x154.png"
/>
<link
rel="apple-touch-icon"
sizes="180x180"
href="/static/apple-touch-icon-180x180.png"
/>
<link rel="stylesheet" href="/static/style.css">
<meta name="theme-color" content="#ff5722">
<meta property="og:type" content="website">
<meta property="og:title" content="정적 블로그 - GitLab Runner, 도커로 자동 배포">
<meta property="og:description" content="공부한 개발 정보를 공유합니다.">
<meta property="og:image" content="https://devblog.lazyig.com/84//static/ogimg.png">
<meta property="og:url" content="https://devblog.lazyig.com/84/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8149987977999297" crossorigin="anonymous"></script>
<link rel="stylesheet"
href="/static/highlight.css">
</head>
<body class="kigui one">
<header class="kigui header">
<div class="header-buttons">
<span id="headerBtn" class="nav-header-btn"><img src="/static/menu-w.svg" alt="Menu"></span>
</div>
<a href="/">
<h1 class="title">
메모용 개발 블로그
</h1>
</a>
</header>
<div class="kigui header-space"></div>
<section class="kigui">
<div id="navBar" class="nav-bar">

<div class="nav-header">
<span id="catToggle" class="nav-header-btn"><img src="/static/menu.svg" alt="Menu"></span>
</div>
<ul class="category">

<li style="padding-left: 0px">
<a href="/c/전체보기/1/">전체보기<span class="nav-cat-cnt">(106)</span></a>
</li>

<li style="padding-left: 15px">
<a href="/c/OS/1/">OS<span class="nav-cat-cnt">(34)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/Linux/1/">Linux<span class="nav-cat-cnt">(23)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/MacOS/1/">MacOS<span class="nav-cat-cnt">(8)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Windows/1/">Windows<span class="nav-cat-cnt">(3)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/데이터베이스/1/">데이터베이스<span class="nav-cat-cnt">(3)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/Oracle/1/">Oracle<span class="nav-cat-cnt">(1)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Postgresql/1/">Postgresql<span class="nav-cat-cnt">(1)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/Develop/1/">Develop<span class="nav-cat-cnt">(22)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/CSS3/1/">CSS3<span class="nav-cat-cnt">(3)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/HTML5/1/">HTML5<span class="nav-cat-cnt">(2)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/JavaScript/1/">JavaScript<span class="nav-cat-cnt">(4)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/React/1/">React<span class="nav-cat-cnt">(1)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Svelte/1/">Svelte<span class="nav-cat-cnt">(2)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/개발일기/1/">개발일기<span class="nav-cat-cnt">(9)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/Git/1/">Git<span class="nav-cat-cnt">(3)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/GitLab/1/">GitLab<span class="nav-cat-cnt">(11)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/Nginx/1/">Nginx<span class="nav-cat-cnt">(7)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/기타/1/">기타<span class="nav-cat-cnt">(14)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/이 블로그의 오픈소스/1/">이 블로그의 오픈소스<span class="nav-cat-cnt">(3)</span></a>
</li>



</ul>
</div>
<script>
let catToggle = document.getElementById("catToggle");
let headerBtn = document.getElementById("headerBtn");
let navBar = document.getElementById("navBar");
catToggle.addEventListener("click", () => {
navBar.classList.toggle("show");
});
headerBtn.addEventListener("click", () => {
navBar.classList.toggle("show");
})
</script>
<div class="kigui frame">
<p class="category-path">

<a href="/c/전체보기/1/">전체보기</a>
<span> > </span>

<a href="/c/개발일기/1/">개발일기</a>
<span> > </span>

</p>
<h1 class="article-title"><a href="https://devblog.lazyig.com/84/">정적 블로그 - GitLab Runner, 도커로 자동 배포</a></h1>
<p class="write-date">2022-12-21 15:20:30</p>
<div class="markdown-body">
<h2>왜 하게 되었나?</h2>
<p>기존에는 GitLab Runner를 Shell을 통하여 구동하고 있었다.</p>
<p>그러나 쉘에서 블로그 페이지 생성 작업과 배포를 수행을 위해서 node.js나 git 등의 환경이 필요하고 이는 만약 환경이 변경되면 다시 세팅을 해주어야 하는 번거로움이 있다.</p>
<p>이러한 것을 손쉽게 해결해줄 방안에는 docker가 있다. 이미 공개된 이미지들을 활용하면 백업본만 살아있다면 OS가 통째로 날아가도 깃랩과 도커만 세팅해주면 바로 사용할 수 있을 것이다.</p>
<p>OS환경에 대한 의존성을 조금 덜어내고자 변경을 수행하였고, 그 과정에서 발생하는 문제점들을 수정해보고자 한다.</p>
<h3>git push 방식 선정 (SSH)</h3>
<p>GitHub Page 저장소를 Pull 받아오는 것은 애초에 Public 저장소이므로 큰 문제가 안되나, Push할 경우에 문제가 발생한다.</p>
<p>현재 GitHub의 보안 정책상 https 프로토콜로 push를 할 시 비밀번호나 토큰을 URL에 넣어서 Push는 할 수 없어서 해당 프로토콜을 제외하였다.</p>
<p>그러면 SSH 프로토콜로 Push하는 것으로 수정하고, 이 경우 비밀번호를 CI/CD 과정 중에 사용하는 것 보다는 해당 저장소 한정으로 권한을 허가 가능하도록 키를 이용하는 방식이 적절하다고 생각되어 이러한 방향으로 작업하게 되었다.</p>
<h2>이슈 정리</h2>
<h4>이슈 1 - 키 등록</h4>
<p>배포시 키와 같은 정보는 GitLab CI/CD 변수 부분을 사용해주도록 하였습니다. 또한 Mask 처리를 하기 위해서 키의 개행 등 비알파벳/숫자를 제거하기 위해서 base64로 인코딩 후 CI/CD 동작 시 디코딩하여 파일에 쓰도록 하였습니다.</p>
<p><img src="/static/img-vq6uWDCsPa_FH87gQr3uSQBqHOFLcLxWZTFBHvrXdws.png" alt="image-20221222000559179"></p>
<p>위 사진은 GitLab Variable 메뉴에 변수를 등록한 모습입니다.</p>
<p>이 경우 키와 키 폴더를 임의로 생성하기에 ssh-keygen 프로그램으로 생성 시 알아서 해줬던 권한 설정은 수작업으로 꼭 해주어야 합니다.</p>
<p>그렇지 않을 경우 적절하지 않은 권한의 키라면서 오류를 뱉게 됩니다.</p>
<pre><code class="language-sh"><span class="hljs-built_in">mkdir</span> ~/.ssh
<span class="hljs-built_in">chmod</span> 700 ~/.ssh
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$GITHUB_DEPLOY_SSH_PRIVATE_KEY</span> | <span class="hljs-built_in">base64</span> --decode &gt;~/.ssh/id_ed25519
<span class="hljs-built_in">chmod</span> 700 ~/.ssh/id_ed25519
</code></pre>
<p>위 커맨드에서 GITHUB_DEPLOY_SSH_PRIVATE_KEY는 변수명 입니다.</p>
<h4>이슈 2 - 키 검사 무시 StrictHost KeyChacking 끄기</h4>
<p>가끔 SSH로 접속하고자 하는 서버가 변경한 경우 중간에 누군가 요청을 가로 챘을 수 있다면서 경고하는 문구를 볼 수 있습니다.</p>
<p>중간자 공격을 막기 위함인데. 이러한 것을 무시해줘야 합니다. 항상 새로운 환경에서 같은 키를 가지고 요청을 보내기 때문에 .ssh/config 파일에 아래 내용을 추가합니다.</p>
<pre><code>Host *
	StrictHostKeyChecking no
</code></pre>
<p>위 내용은 아래처럼 명령어를 통해서 생성하도록 하였습니다.</p>
<pre><code class="language-sh"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;Host *\n\tStrictHostKeyChecking no\n\n&quot;</span> &gt; ~/.ssh/config
</code></pre>
<h4>이슈 3 - known_hosts 등록</h4>
<p>처음 연결하는 대상 서버로 연결 시 핑거 프린트를 등록하겠냐는 yes/no 입력이 나타나는데.</p>
<p>이 경우 CI/CD 실행 중 진행할 수 없으므로 러너 구동이 실패처리 됩니다.</p>
<p>미리 github의 정보를 받아와서 known_hosts에 등록해줘야 합니다.</p>
<pre><code class="language-sh">ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts
<span class="hljs-built_in">chmod</span> 644 ~/.ssh/known_hosts
</code></pre>

</div>
</div>
<div class="kigui frame">
<script src="https://utteranc.es/client.js"
repo="lazyig/blog-comment"
issue-term="pathname"
label="blog-comment"
theme="github-light"
crossorigin="anonymous"
async>
</script>
</div>
</section>
</body>
</html>