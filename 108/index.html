<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GitLab Registry+GitLab Runner에서 비공개 저장소 사용</title>
<meta
name="description"
content="정적페이지로 운영하는 개발 블로그입니다."
/>
<link
rel="shortcut icon"
type="image/png"
sizes="144x144"
href="/static/favicon-144x144.png"
/>
<link
rel="icon"
type="image/png"
sizes="16x16"
href="/static/favicon-16x16.png"
/>
<link
rel="icon"
type="image/png"
sizes="32x32"
href="/static/favicon-32x32.png"
/>
<link
rel="icon"
type="image/png"
sizes="192x192"
href="/static/favicon-192x192.png"
/>
<link
rel="apple-touch-icon"
sizes="57x57"
href="/static/apple-touch-icon-57x57.png"
/>
<link
rel="apple-touch-icon"
sizes="72x72"
href="/static/apple-touch-icon-72x72.png"
/>
<link
rel="apple-touch-icon"
sizes="76x76"
href="/static/apple-touch-icon-76x76.png"
/>
<link
rel="apple-touch-icon"
sizes="114x114"
href="/static/apple-touch-icon-114x114.png"
/>
<link
rel="apple-touch-icon"
sizes="120x120"
href="/static/apple-touch-icon-120x120.png"
/>
<link
rel="apple-touch-icon"
sizes="144x144"
href="/static/apple-touch-icon-144x144.png"
/>
<link
rel="apple-touch-icon"
sizes="152x152"
href="/static/apple-touch-icon-152x152.png"
/>
<link
rel="apple-touch-icon"
sizes="154x154"
href="/static/apple-touch-icon-154x154.png"
/>
<link
rel="apple-touch-icon"
sizes="180x180"
href="/static/apple-touch-icon-180x180.png"
/>
<link rel="stylesheet" href="/static/style.css">
<meta name="theme-color" content="#ff5722">
<meta property="og:type" content="website">
<meta property="og:title" content="GitLab Registry+GitLab Runner에서 비공개 저장소 사용">
<meta property="og:description" content="공부한 개발 정보를 공유합니다.">
<meta property="og:image" content="https://devblog.lazyig.com/108//static/ogimg.png">
<meta property="og:url" content="https://devblog.lazyig.com/108/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8149987977999297" crossorigin="anonymous"></script>
<link rel="stylesheet"
href="/static/highlight.css">
</head>
<body class="kigui one">
<header class="kigui header">
<div class="header-buttons">
<span id="headerBtn" class="nav-header-btn"><img src="/static/menu-w.svg" alt="Menu"></span>
</div>
<a href="/">
<h1 class="title">
메모용 개발 블로그
</h1>
</a>
</header>
<div class="kigui header-space"></div>
<section class="kigui">
<div id="navBar" class="nav-bar">

<div class="nav-header">
<span id="catToggle" class="nav-header-btn"><img src="/static/menu.svg" alt="Menu"></span>
</div>
<ul class="category">

<li style="padding-left: 0px">
<a href="/c/전체보기/1/">전체보기<span class="nav-cat-cnt">(110)</span></a>
</li>

<li style="padding-left: 15px">
<a href="/c/OS/1/">OS<span class="nav-cat-cnt">(35)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/Linux/1/">Linux<span class="nav-cat-cnt">(23)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/MacOS/1/">MacOS<span class="nav-cat-cnt">(8)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Windows/1/">Windows<span class="nav-cat-cnt">(4)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/데이터베이스/1/">데이터베이스<span class="nav-cat-cnt">(3)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/Oracle/1/">Oracle<span class="nav-cat-cnt">(1)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Postgresql/1/">Postgresql<span class="nav-cat-cnt">(1)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/Develop/1/">Develop<span class="nav-cat-cnt">(23)</span></a>
</li>

<li style="padding-left: 30px">
<a href="/c/CSS3/1/">CSS3<span class="nav-cat-cnt">(3)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/HTML5/1/">HTML5<span class="nav-cat-cnt">(2)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/JavaScript/1/">JavaScript<span class="nav-cat-cnt">(4)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/React/1/">React<span class="nav-cat-cnt">(1)</span></a>
</li>


<li style="padding-left: 30px">
<a href="/c/Svelte/1/">Svelte<span class="nav-cat-cnt">(2)</span></a>
</li>



<li style="padding-left: 15px">
<a href="/c/개발일기/1/">개발일기<span class="nav-cat-cnt">(9)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/Git/1/">Git<span class="nav-cat-cnt">(3)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/GitLab/1/">GitLab<span class="nav-cat-cnt">(12)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/Nginx/1/">Nginx<span class="nav-cat-cnt">(7)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/기타/1/">기타<span class="nav-cat-cnt">(15)</span></a>
</li>


<li style="padding-left: 15px">
<a href="/c/이 블로그의 오픈소스/1/">이 블로그의 오픈소스<span class="nav-cat-cnt">(3)</span></a>
</li>



</ul>
</div>
<script>
let catToggle = document.getElementById("catToggle");
let headerBtn = document.getElementById("headerBtn");
let navBar = document.getElementById("navBar");
catToggle.addEventListener("click", () => {
navBar.classList.toggle("show");
});
headerBtn.addEventListener("click", () => {
navBar.classList.toggle("show");
})
</script>
<div class="kigui frame">
<p class="category-path">

<a href="/c/전체보기/1/">전체보기</a>
<span> > </span>

<a href="/c/GitLab/1/">GitLab</a>
<span> > </span>

</p>
<h1 class="article-title"><a href="https://devblog.lazyig.com/108/">GitLab Registry+GitLab Runner에서 비공개 저장소 사용</a></h1>
<p class="write-date">2023-05-03 12:05:19</p>
<div class="markdown-body">
<p>GitLab Runner에서 GitLab private registry의 이미지를 사용하는 과정을 정리하고자 합니다.</p>
<p>이 글에서 깃랩의 버전은  <code>15.11.1</code>입니다.</p>
<h2>Docker 설정</h2>
<p>컨테이너를 빌드하고 배포하는데는 Docker가 필요합니다. 이때 스크립트를 실행하는 환경에 따라 추가 설정이 필요할 수 있습니다.</p>
<p>GitLab Runner를 <code>shell</code> 환경에서 구동하는 경우 별 다른 설정이 필요없으나, <code>docker</code> 컨테이너 내부에서 구동하고자 할 경우 추가적인 설정이 필요합니다.</p>
<p>도커를 실행해야할 러너를 등록합니다.</p>
<p>이 후 등록이 끝났다면 GitLab Runner의 설정파일(<code>config.toml</code>)을 엽니다. 해당 파일은 구동 중인 러너의 위치 혹은 구동 중인 계정의 홈 폴더 하위에 존재합니다.</p>
<p>등록한 러너의 설정을 찾아 <code>volumes</code>라는 항목을 찾습니다.</p>
<p>해당 영역이 러너에서 도커 컨테이너를 올릴 시 마운트할 볼륨의 경로입니다. 추가 마운트 항목에 <code>/var/run/docker.sock:/var/run/docker.sock</code>를 추가합니다. 예시로 아래와 같이 설정하였습니다.</p>
<pre><code class="language-toml"><span class="hljs-attr">volumes</span> = [<span class="hljs-string">&quot;/cache&quot;</span>, <span class="hljs-string">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span>]
</code></pre>
<p>이렇게 하면 도커 컨테이너 내부에서 외부 도커 소켓을 사용하여 접근할 수 있습니다.</p>
<h2>빌드 &amp; 배포</h2>
<p>비공개 개인 사설 컨테이너 저장소에 접근하기 위해서는 해당 저장소에 대한 주소, 아이디, 비밀번호를 알고 있어야 합니다. 이 글의 경우에는 GitLab의 개인 사설 컨테이너 저장소를 사용하므로 배포 과정에서 사전 정의된 변수들을 활용하여 별다른 설정 없이 해당 깃 저장소의 컨테이너 저장소에 접근할 수 있습니다.</p>
<p>러너를 구동하기 위해서 <code>.gitlab-ci.yml</code>파일을 작성합니다.</p>
<pre><code class="language-yaml"><span class="hljs-attr">stages:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">release</span>
    
<span class="hljs-attr">Release docker image:</span>
    <span class="hljs-attr">stage:</span> <span class="hljs-string">release</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">docker:20.10.16</span>
    <span class="hljs-attr">rules:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">if:</span> <span class="hljs-string">$CI_COMMIT_TAG</span>
    <span class="hljs-attr">before_script:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">-u</span> <span class="hljs-string">&quot;$CI_REGISTRY_USER&quot;</span> <span class="hljs-string">-p</span> <span class="hljs-string">&quot;$CI_REGISTRY_PASSWORD&quot;</span> <span class="hljs-string">$CI_REGISTRY</span>
    <span class="hljs-attr">script:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:latest</span> <span class="hljs-string">||</span> <span class="hljs-literal">true</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">build</span> <span class="hljs-string">--cache-from</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:latest</span> <span class="hljs-string">--tag</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:latest</span> <span class="hljs-string">--tag</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG</span> <span class="hljs-string">.</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:latest</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG</span>
    <span class="hljs-attr">tags:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">설정한_러너_태그</span>
</code></pre>
<p>여기서 이미지는 <code>docker:20.10.16</code>을 사용하였습니다.</p>
<p><code>before_script</code>영역에는 도커 로그인을 해놓습니다. 여기서 GitLab에서 사전정의된 변수를 활용하여 추가 설정 없이 아이디(<code>$CI_REGISTRY_USER</code>), 비밀번호(<code>$CI_REGISTRY_PASSWORD</code>), 레지스트리 주소(<code>$CI_REGISTRY</code>)를 가져올 수 있습니다.</p>
<p>이후 <code>script</code>영역입니다.</p>
<pre><code class="language-sh">docker pull <span class="hljs-variable">$CI_REGISTRY_IMAGE</span>:latest || <span class="hljs-literal">true</span>
</code></pre>
<p>최신 컨테이너 이미지를 받습니다. 이미 존재하는 레이어에 관해서는 추가적인 빌드를 하지 않을 수 있기 때문에 유용합니다. 해당 스크립트는 실패할 수도 있지만 진행에 문제가 없으므로 stderr가 발생하지 않도록 <code>|| true</code>를 추가해줍니다.</p>
<pre><code class="language-sh">docker build --cache-from <span class="hljs-variable">$CI_REGISTRY_IMAGE</span>:latest --tag <span class="hljs-variable">$CI_REGISTRY_IMAGE</span>:latest --tag <span class="hljs-variable">$CI_REGISTRY_IMAGE</span>:<span class="hljs-variable">$CI_COMMIT_TAG</span> .
</code></pre>
<p>도커 빌드를 진행합니다.</p>
<p><code>--cache-from $CI_REGISTRY_IMAGE:latest</code> 매개변수를 이용하여  이전 명령어에서 받은 최신 빌드를 캐시로 사용합니다.</p>
<p><code>--tag</code> 매개변수는 각 이미지에 붙을 태그명입니다. 이 글에서는 최신 버전인  <code>:latest</code>태그와 깃에서 지정한 tag를 활용한  <code>:1.0.0</code> 같은 버전으로 된 태그를 생성하도록 하고 있습니다.</p>
<p>마지막으로 <code>.</code> 부분은 Dockerfile이 위치할 경로를 지정합니다.</p>
<pre><code class="language-sh">docker push <span class="hljs-variable">$CI_REGISTRY_IMAGE</span>:latest
docker push <span class="hljs-variable">$CI_REGISTRY_IMAGE</span>:<span class="hljs-variable">$CI_COMMIT_TAG</span>
</code></pre>
<p>이후 각 이미지를 배포합니다.</p>
<p>작성을 마친 뒤에는 파이프라인을 동작시켜봅니다.</p>
<p><img src="/static/img-qJuvBRGRtyeoT9E_AhEnGaq_OAmUsiVJAL5scJGehyc.png" alt="image-20230503203725728"></p>
<p>파이프라인이 성공하면 GitLab에 들어가서 배포가 되었는지 확인합니다.</p>
<h2>컨테이너 사용</h2>
<p>배포한 컨테이너를 pull 받기 위해서 로그인이 필요합니다.</p>
<p>이때 GitLab의 아이디와 비밀번호를 사용할 수도 있지만 토큰을 발급하여 사용할 수도 있습니다.</p>
<h3>사용자 단위 토큰 발급 발급</h3>
<p>사용자 단위 토큰은 해당 사용자의 권한으로 접근 가능한 저장소를 모두 활용할 수 있습니다.</p>
<p>개인적으로 테스트를 하거나 할 경우 발급해서 로컬에 등록하시면 편하게 사용할 수 있습니다.</p>
<p>우측 상단 유저 프로필 &gt; <code>Preferences</code> &gt; <code>Access Tokens</code></p>
<p><img src="/static/img-PNf90ruOqfmC0oZ7LanW8PhMyPhoimPCSeYHunQlAPw.png" alt="image-20230503204546924"></p>
<p><code>read_registry</code>권한을 허가한 후 생성합니다.</p>
<p><img src="/static/img-xtpUX-piaSBXVx9bqsti0Rekfm1f7sKUhzqarOmKSNY.png" alt="image-20230503204802639"></p>
<p>이후 생성된 키를 복사한 후 활용합니다.</p>
<h3>프로젝트 단위 토큰</h3>
<p>프로젝트 단위 토큰은 해당 프로젝트의 레지스트리만 접근할 수 있습니다. 특정 배포 스크립트나 특정 환경에서 해당 레지스트리만 사용할 경우 보안 측면에서 사용하기 좋습니다.</p>
<p>프로젝트 좌측 메뉴에서 <code>Settings</code> &gt; <code>Access Tokens</code>메뉴에서 생성합니다.</p>
<p><img src="/static/img-nyntptGPXw7OL_nCKWgV7w9kZTQyCp39Y1o5Am-Es3A.png" alt="image-20230503205036587"></p>
<p><code>read_registry</code>권한을 체크한 후 발급하여 사용합니다.</p>
<h3>로그인</h3>
<p>명령어를 친절하게 깃랩에서 복사할 수 있도록 마련되어있다.</p>
<p><img src="/static/img-FfCAPs-PJq4WcoXHmh85Ama--Mdfye4Bx2b-wXB_FuE.png" alt="image-20230503231956251"></p>
<p>우측 상단의 <code>CLI Commands</code> 버튼을 클릭한 뒤 Login 스크립트를 복사합니다.</p>
<pre><code class="language-sh">docker login 깃랩주소
</code></pre>
<p>위와 같이 나오는데. 사용할 곳에서 명령어를 입력하면 대화식으로 로그인 정보를 입력할 수 있습니다.</p>
<p>혹은, 아래 처럼 인수로 넘길 수도 있습니다.</p>
<pre><code class="language-sh">docker login 깃랩주소 -u 아이디 -p 비밀번호
</code></pre>
<p>하지만, 위 처럼 할 경우 히스토리에 남으므로 보안상 지워주는 것이 좋습니다.</p>
<p>로그인이 성공하면 다음과 같이 출력합니다.</p>
<pre><code>WARNING! Your password will be stored unencrypted in /홈_경로/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
</code></pre>
<p>암호화 되지 않은 비밀번호가 저장되어 있으니 주의하라고 합니다.</p>
<p>실제로 아이디와 비밀번호를 단순히 base64 인코딩하여 저장합니다.</p>
<p>credential helper를 사용하여 보안성을 높일 수 있으니 필요하면 참고합니다.</p>
<p>이후 docker pull을 받으시면 정상적으로 사용됩니다.</p>

</div>
</div>
<div class="kigui frame">
<script src="https://utteranc.es/client.js"
repo="lazyig/blog-comment"
issue-term="pathname"
label="blog-comment"
theme="github-light"
crossorigin="anonymous"
async>
</script>
</div>
</section>
</body>
</html>